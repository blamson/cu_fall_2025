---
title: "Data Cleaning"
author: "Brady Lamson"
format: html
self-contained: true
---

```{r, include=FALSE}
packages <- c("readr", "dplyr", "tidyr", "here", "sf", "smerc", "spdep", "ggplot2", "maps")

for (pkg in packages) {
  if (!require(pkg, character.only = TRUE, quietly = TRUE)) {
    install.packages(pkg, repos = "https://cran.rstudio.com/")
    library(pkg, character.only = TRUE)
  }
}

df <- readr::read_csv(here::here("final-project/data/maryland_bees.csv"))
```

The goal of this notebook is to further clean up the maryland bee data file, hopefully iron out the spatial data quality and randomly sample down to a smaller dataset for the project. 

# Regional Wackery

To be honest, to keep it simple here just remove any of the points that fall outside the bounds of maryland. We're going to still have some bad data but we can discuss that in the paper. 

```{r}
maryland <- maps::map("state", region = "maryland", fill = TRUE, plot = FALSE)
maryland <- st_as_sf(maryland)
maryland <- st_set_crs(maryland, 4326)
maryland <- st_transform(maryland, 6487)

sf_bees <- st_as_sf(df, coords = c("decimalLongitude", "decimalLatitude"))
st_crs(sf_bees) <- 4326
sf_bees <- st_transform(sf_bees, 6487)
sf_bees <- sf_bees %>%
    mutate(geometry = st_jitter(geometry))
```

```{r, echo=FALSE}
sf_bees <- sf_bees[st_intersects(sf_bees, maryland, sparse = FALSE), ] # only keep points in maryland bounds
ggplot() +
    geom_sf(data = maryland, fill = "white", color = "gray40") + 
    geom_sf(data = sf_bees, aes(color=as.factor(decade)), alpha = 0.3, pch=21, size = 1) + 
    theme_minimal() +
    labs(
        title = "Bee Observations Across Maryland",
        color = "Decade"
    )
```

# Create random sample stratified by decade

```{r}
set.seed(100)
decade_sample <- sf_bees %>%
    filter(!is.na(locality)) %>% # just to ditch some probably bad data
    select(c("gbifID", "year", "decade", "geometry")) %>%
    group_by(decade) %>%
    dplyr::slice_sample(n=500)

ggplot() +
    geom_sf(data = maryland, fill = "white", color = "gray40") + # Plot the maryland borders
    geom_sf(data = decade_sample, aes(color=as.factor(decade)), alpha = 0.3, pch=21, size = 1) + # plot the BEEEEES
    theme_minimal() +
    labs(
        title = "Bee Observations Across Maryland",
        color = "Decade"
    )

# sf::st_write(decade_sample, "final-project/data/maryland_bee_decade_rs.gpkg")
```

# Create random sample stratified by family

Let's force 500 rows per decade here. We have plenty of data for that. 

```{r}
set.seed(100)
bees_sampled <- sf_bees %>%
    filter(
        (!is.na(locality)) &
        !(family %in% c("Colletidae", "Melittidae", "Megachilidae"))
    ) %>%
    group_by(family) %>%
    dplyr::slice_sample(n=500)
```

Plot one more time. 

```{r}
ggplot() +
    geom_sf(data = maryland, fill = "white", color = "gray40") + # Plot the maryland borders
    geom_sf(data = bees_sampled, aes(color=as.factor(family)), alpha = 0.3, pch=21, size = 1) + # plot the BEEEEES
    theme_minimal() +
    labs(
        title = "Bee Observations Across Maryland",
        color = "Decade"
    )
```

# Trim down the columns

```{r}
bees_sampled <- bees_sampled %>% 
    select(c("gbifID", "family", "locality", "year", "decade", "geometry"))
```

# Write Dataset

```{r}
sf::st_write(bees_sampled, "final-project/data/maryland_bee_family_rs.gpkg")
```